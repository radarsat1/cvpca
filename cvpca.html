<html>
<head>
<title>CvPCA</title>
<script language="javascript">

var ws;

function open_web_socket()
{
    var text = document.getElementById('text');
    var WebSock = null;
    if (typeof MozWebSocket!=='undefined')
        WebSock = MozWebSocket;
    else
        WebSock = WebSocket;
    var url = "ws://localhost:8080";
    ws = new WebSock(url, 'phonepca');

    var onclose = function () {
        if (text.innerHTML.search('closed') == -1)
            text.innerHTML = '<br>websocket closed "'+url+'"' + text.innerHTML;

        // Try again in 3 seconds
        setTimeout(open_web_socket, 3000);
    };

    ws.onopen = function () {
        text.innerHTML = '<br>websocket open "'+url+'"';
        ws.recording = false;
        ws.send('I ' + 'Browser id?');
        var t = setInterval(function(){
            if (ws.recording)
                ws.send('G ' + (new Date()-0) + ' '
                        + [Math.random()*4-2,
                           Math.random()*4-2,
                           Math.random()*4-2]);
        }, 100);

        ws.onclose = function() {
            ws.onclose = onclose;
            clearInterval(t);
            onclose();
        }
    };

    ws.onmessage = function (msg) {
        text.innerHTML = '<br>websocket message: "'+msg.data+'"' + text.innerHTML;
        command = JSON.parse(msg.data);
        console.log(command);
        if (command.cmd === 'start')
            ws.recording = true;
        else if (command.cmd === 'stop')
            ws.recording = false;
        else if (command.cmd === 'params')
            ws.params = command;
    };

    ws.onclose = onclose;

    return ws;
}

function init()
{
    ws = open_web_socket();
}

</script>
</head>
<body onload="init();">
<div id='text'></div>
</body>
</html>
